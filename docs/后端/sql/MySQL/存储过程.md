# 存储过程 PROCEDURE

什么是存储过程，简单来说，就是为以后的使用而保存的一条或多条 MySQL 语句的集合。可将其视为批文件，虽然它们的作用不仅限于批处理。

使用存储过程的好处：

- 拆分复杂的操作，封装成更小的单元，简化操作。
- 团队成员复用，保持一致的团队操作，降低出错。
- 解耦，如果表名，列名或业务逻辑变化，只需要修改封装好的存储过程即可，不用修改业务代码。
- 提高性能。因为使用存储过程比使用单独的SQL语句要快。
- 一些只能用在单个请求中的 MySQL 元素和特性，存储过程可以使用它们来编写功能更强更灵活的代码。

存储过程的好处总结：简单、安全、高性能。

一般来说，存储过程的编写比基本 SQL 语句复杂，编写存储过程需要更高的技能，更丰富的经验。

你可能没有创建存储过程的安全访问权限。许多数据库管理员限制存储过程的创建权限，允许用户使用存储过程，但不允许他们创建存储过程。

## 创建存储过程 `CREATE PROCEDURE`

语法：

```sql
# 存储过程其实是一种函数，所以名称后有一对圆括号，如果存储过程接受参数，它们将在 () 中列举出来。
CREATE PROCEDURE <存储过程名称>() BEGIN <封装的语句> END;
```

示例：

```sql
# 创建一个存储过程，用于获得用户表中所有用户的平均年龄
CREATE PROCEDURE avg_user_age()
BEGIN
SELECT Avg(age) AS avg_age from users;
END;
```

上例中，`CREATE PROCEDURE avg_user_age()` 创建一个名为 `avg_user_age` 且不需要参数的存储过程， `BEGIN` 和 `END` 语句用来限定存储过程体，指示开始和结束。

上例中，`BEGIN` 和 `END` 中间的语句结束使用了分号 `;` ，创建存储过程的整个语句末尾也有分号 `;` ，这在命令行程序中使用时会出现句法错误，解决办法是临时更改命令行实用程序的语句分隔符。

```sql
DELIMITER //

CREATE PROCEDURE avg_user_age()
BEGIN
SELECT Avg(age) AS avg_age from users;
END //

DELIMITER ;
```

开头的 `DELIMITER //` 表示临时指定语句分隔符为 `//` ， 所以创建语句的末尾使用了 `END //` 作为语句结束分隔符。最后 `DELIMITER ;` 将分隔符恢复成分号。

除了 `/` 符号外，其他的字符都可以用来指定为临时分隔符。

调用存储过程使用 `CALL` 关键字：

```sql
CALL avg_user_age();
```

### 带参数的存储过程

创建带参数的存储过程，每个参数都有三部分组成，分别是 `<参数类型> <参数名称> <参数数据类型>` 。

参数类型取值为以下之一：

- `IN` 调用时传递给存储过程的参数，相当于是存储过程函数接收调用传递过来的值
- `OUT` 从存储过程传出给调用者的参数，相当于函数返回值
- `INOUT` 对存储过程传入和传出，即是接收的参数，又是返回值

参数名任意定义，参数数据类型就是 MySQL 支持的数据类型。

语法：

```sql
CREATE PROCEDURE <存储过程名称>(
  <参数类型> <参数名称> <参数数据类型>,
  <参数类型> <参数名称> <参数数据类型>,
  <参数类型> <参数名称> <参数数据类型>,
  ...
) BEGIN <封装的语句> END;
```

在封装的语句中，通过 `INTO` 关键字将值传给 `OUT` 类型的参数，比如 `SELECT <列名> INTO <参数名称> ...`

示例：

```sql
# 创建一个存储过程，可获取用户表中最大年龄，最小年龄，平均年龄
CREATE PROCEDURE user_age(
  OUT maxa INT,
  OUT mina INT,
  OUT avga INT,
)
BEGIN
SELECT Max(age) INTO maxa from users;
SELECT min(age) INTO mina from users;
SELECT avg(age) INTO avga from users;
END;
```

上例中，创建了一个存储过程叫做 `user_age` , 它接收三个参数，分别是 `maxa`, `mina`, `avga`, 每个参数必须具有指定的类型。

关键字 `OUT` 指出相应的参数用来从存储过程传出一个值（返回给调用者）。

封装的语句中，通过 INTO 关键字将查询出的值赋值给了 `maxa`, `mina`, `avga` 这三个参数。

调用带参数的存储过程：

```sql
# 所有 MySQL 变量命名都必须以 @ 开始
# 变量名不需要和存储过程的参数名相同，但顺序和数量必须一致。
CALL user_age(@max_age, @min_age, @avg_age);
```

在调用语句执行之后，这条语句并不显示任何数据。它仅仅返回了这三个变量，可以在之后使用这三个变量。

访问 **调用存储过程返回的变量**：

```sql
# 直接访问变量，这条语句查询出三列，分别是这三个变量，以及他们的值
SELECT @max_age, @min_age, @avg_age
```

## 显示创建一个存储过程的语句

```sql
# 查看创建存储过程的语句
SHOW CREATE PROCEDURE <存储过程名称>;

# 查看何时、由谁创建等详细信息，列出所有存储过程
SHOW PROCEDURE STATUS;

# 为限制其输出，可使用 LIKE 指定一个过滤模式
SHOW PROCEDURE STATUS LIKE '<过滤模式>';
```

## 删除存储过程

存储过程在创建之后，被保存在服务器上以供使用，直至被删除。

```sql
# 如果指定的过程不存在，将产生一个错误
DROP PROCEDURE <存储过程名称>;

# 判断当指定的存储过程存在时，才将它删除
DROP PROCEDURE IF EXISTS <存储过程名称>;
```
