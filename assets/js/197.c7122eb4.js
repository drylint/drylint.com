(window.webpackJsonp=window.webpackJsonp||[]).push([[197],{409:function(s,a,t){"use strict";t.r(a);var e=t(6),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"触发器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#触发器"}},[s._v("#")]),s._v(" 触发器")]),s._v(" "),a("p",[s._v("MySQL 语句在需要时被执行，存储过程也是如此。但是，如果你想要某条语句（或某些语句）在事件发生时自动执行，怎么办呢？")]),s._v(" "),a("p",[s._v("触发器是 MySQL 响应 "),a("code",[s._v("DELETE")]),s._v(", "),a("code",[s._v("INSERT")]),s._v(", "),a("code",[s._v("UPDATE")]),s._v(" 语句而自动执行的一条语句。")]),s._v(" "),a("p",[s._v("在 MySQL 5中，触发器名必须在每个表中唯一，但不是在每个数据库中唯一。这在其他每个数据库触发器名必须唯一的 DBMS 中是不允许的，但尽量应该在数据库范围内使用唯一的触发器名。")]),s._v(" "),a("h2",{attrs:{id:"创建触发器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建触发器"}},[s._v("#")]),s._v(" 创建触发器")]),s._v(" "),a("p",[s._v("触发器用 "),a("code",[s._v("CREATE TRIGGER")]),s._v(" 语句创建：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRIGGER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("触发器名"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BEFORE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AFTER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DELETE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("表名"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR EACH ROW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("触发器执行的语句"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("上述语句中：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("CREATE TRIGGER <触发器名>")]),s._v(" 创建触发器")]),s._v(" "),a("li",[a("code",[s._v("<BEFORE | AFTER> <INSERT | UPDATE | DELETE>")]),s._v(" 表示可以在 "),a("code",[s._v("INSERT")]),s._v(", "),a("code",[s._v("UPDATE")]),s._v(", "),a("code",[s._v("DELETE")]),s._v(" 语句之前或之后执行，"),a("code",[s._v("BEFORE")]),s._v(" 通常用于拦截验证数据。")]),s._v(" "),a("li",[a("code",[s._v("ON <表名>")]),s._v(" 指定触发器监听的是哪一张表，只有表才支持触发器，视图不支持。")]),s._v(" "),a("li",[a("code",[s._v("FOR EACH ROW <触发器执行的语句>")]),s._v(" 表示对每一行的操作都执行什么语句")])]),s._v(" "),a("p",[s._v("触发器按每个表每个事件每次地定义，每个表每个事件每次只允许一个触发器。因此，每个表最多支持 6 个触发器，分别是：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("BEFORE INSERT")])]),s._v(" "),a("li",[a("code",[s._v("AFTER INSERT")])]),s._v(" "),a("li",[a("code",[s._v("BEFORE UPDATE")])]),s._v(" "),a("li",[a("code",[s._v("AFTER UPDATE")])]),s._v(" "),a("li",[a("code",[s._v("BEFORE DELETE")])]),s._v(" "),a("li",[a("code",[s._v("AFTER DELETE")])])]),s._v(" "),a("p",[s._v("一个触发器不能与多个事件或多个表关联，比如，如果你需要对 "),a("code",[s._v("INSERT")]),s._v(" 和 "),a("code",[s._v("UPDATE")]),s._v(" 触发相同的操作，也需要分别定义两个触发器。")]),s._v(" "),a("p",[s._v("触发器的执行流程："),a("code",[s._v("BEFORE => 增/删/改语句 => AFTER")]),s._v(" ，任意一个环节出错后，后续都不会再执行。")]),s._v(" "),a("h3",{attrs:{id:"insert-语句的触发器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#insert-语句的触发器"}},[s._v("#")]),s._v(" INSERT 语句的触发器")]),s._v(" "),a("ul",[a("li",[s._v("在 INSERT 触发器代码内，可引用一个名为 "),a("code",[s._v("NEW")]),s._v(" 的关键字，表示被插入的行数据")]),s._v(" "),a("li",[s._v("在 "),a("code",[s._v("BEFORE INSERT")]),s._v(" 触发器中， 可以拦截并修改 "),a("code",[s._v("NEW")]),s._v(" 中的值，也就是更改被插入的行数据")]),s._v(" "),a("li",[s._v("对于 "),a("code",[s._v("AUTO_INCREMENT")]),s._v(" 列， "),a("code",[s._v("NEW")]),s._v(" 在 "),a("code",[s._v("INSERT")]),s._v(" 执行之前包含 "),a("code",[s._v("0")]),s._v(" ，在 "),a("code",[s._v("INSERT")]),s._v(" 执行之后包含新的自动生成值")])]),s._v(" "),a("p",[s._v("比如，确定新插入行的 "),a("code",[s._v("AUTO_INCREMENT")]),s._v(" 列的值：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 假设 orders 表中，id 是自增列，触发器语句中通过 NEW 访问插入的行数据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRIGGER")]),s._v(" after_orders_insert\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AFTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" orders\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR EACH ROW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" NEW"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"delete-语句的触发器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#delete-语句的触发器"}},[s._v("#")]),s._v(" DELETE 语句的触发器")]),s._v(" "),a("ul",[a("li",[s._v("在 "),a("code",[s._v("DELETE")]),s._v(" 触发器代码内，你可以引用一个名为 "),a("code",[s._v("OLD")]),s._v(" 的关键字，表示被删除的行数据")]),s._v(" "),a("li",[a("code",[s._v("OLD")]),s._v(" 中的值全都是只读的，不能修改。")])]),s._v(" "),a("p",[s._v("比如，在删除 "),a("code",[s._v("orders")]),s._v(" 订单表每一行数据之前，先把这一行数据存到另一张存档表  "),a("code",[s._v("archive_orders")]),s._v(" 之中：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRIGGER")]),s._v(" before_orders_delete\nBEFORE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DELETE")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" orders\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR EACH ROW")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果要完全复制行数据，并且两张表结构一致的话，")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可使用 INSERT INTO archive_orders VALUES OLD;")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" archive_orders"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" order_num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("OLD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" OLD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("order_num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" OLD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("上例中，"),a("code",[s._v("BEGIN ... AND;")]),s._v(" 语句不是必须的，但是没有坏处，使用 "),a("code",[s._v("BEGIN ... AND;")]),s._v(" 则可以兼容执行多条语句的情况。")]),s._v(" "),a("h3",{attrs:{id:"update-语句的触发器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#update-语句的触发器"}},[s._v("#")]),s._v(" UPDATE 语句的触发器")]),s._v(" "),a("ul",[a("li",[s._v("在 "),a("code",[s._v("UPDATE")]),s._v(" 触发器执行的语句中，可以引用一个名为 "),a("code",[s._v("OLD")]),s._v(" 的关键字访问更新前的旧值，引用一个名为 "),a("code",[s._v("NEW")]),s._v(" 的关键字访问新更新的值；")]),s._v(" "),a("li",[s._v("在 "),a("code",[s._v("BEFORE UPDATE")]),s._v(" 触发器执行的语句中，可以拦截并修改 "),a("code",[s._v("NEW")]),s._v(" 中的值，也就是更改被插入的数据，")]),s._v(" "),a("li",[a("code",[s._v("OLD")]),s._v(" 中的值全都是只读的，不能更新。")])]),s._v(" "),a("p",[s._v("比如，更新 users 用户表的数据时，拦截新数据中的 email 字段，存储为全小写：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRIGGER")]),s._v(" before_users_update\nBEFORE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" users\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR EACH ROW")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BEGIN")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SET")]),s._v(" NEW"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Lower"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("NEW"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("email"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("可以看到，用触发器来保证数据的一致性（大小写、格式等）是非常方便的。在触发器中执行这种类型的处理的优点是它总是会进行这种处理，而且是透明地进行，与客户机应用无关。")]),s._v(" "),a("p",[s._v("遗憾的是，MySQL触发器中不支持 CALL 语句。这表示不能从触发器内调用存储过程。所需的存储过程代码需要复制到触发器内。")]),s._v(" "),a("h2",{attrs:{id:"删除触发器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除触发器"}},[s._v("#")]),s._v(" 删除触发器")]),s._v(" "),a("p",[s._v("触发器不能更新或覆盖。为了修改一个触发器，必须先删除它，然后再重新创建。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DROP")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TRIGGER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("触发器名"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);a.default=r.exports}}]);